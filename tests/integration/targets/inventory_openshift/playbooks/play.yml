---
- name: Converge
  hosts: localhost
  connection: local
  tasks:
    - name: Delete existing namespace
      community.okd.k8s:
        api_version: v1
        kind: Namespace
        name: inventory
        wait: yes
        state: absent

    - name: Ensure namespace exists
      community.okd.k8s:
        api_version: v1
        kind: Namespace
        name: inventory

    - name: Add a simple Pod
      k8s:
        namespace: inventory
        definition:
          apiVersion: v1
          kind: Pod
          metadata:
            name: pypod
          spec:
            containers:
            - name: pycontainer
              image: "python:3.8.13"
              command:
                - /bin/sh
                - -c
                - while true;do date;sleep 5; done
        wait: yes
        wait_timeout: 400

    - meta: refresh_inventory

- name: Verify inventory and connection plugins
  # This group is created by the openshift_inventory plugin
  # It is automatically configured to use the `oc` connection plugin
  hosts: namespace_inventory_pods
  gather_facts: false
  vars:
    file_content: |
      Hello world
    ansible_python_interpreter: "/usr/local/bin/python"
  tasks:
    - name: End play if host not running (TODO should we not add these to the inventory?)
      meta: end_host
      when: pod_phase != "Running"

    - setup:

    - debug: var=ansible_facts

    - name: Assert the TEST environment variable was retrieved
      assert:
        that: 
          - ansible_facts.python.executable == "/usr/local/bin/python"
          - ansible_facts.python_version == "3.8.13"

    - name: Copy a file into the host
      copy:
        content: '{{ file_content }}'
        dest: /tmp/test_file

    - name: Retrieve the file from the host
      slurp:
        src: /tmp/test_file
      register: slurped_file

    - name: Assert the file content matches expectations
      assert:
        that: (slurped_file.content|b64decode) == file_content

- name: Delete inventory namespace
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Remove inventory namespace
      community.okd.k8s:
        api_version: v1
        kind: Namespace
        name: inventory
        state: absent
